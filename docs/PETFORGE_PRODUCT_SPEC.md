# PetForge 批量处理工坊 - 产品规格说明书

> **版本**: 2.1  
> **更新日期**: 2026-01-27  
> **页面地址**: http://localhost:5173/batch

---

## 一、产品概述

### 1.1 产品定位

**PetForge 批量处理工坊** 是一个基于飞书多维表格的**批量视频生产平台**，专为宠物类短视频内容的规模化生产而设计。

### 1.2 核心价值

| 价值维度 | 描述 |
|---------|------|
| **效率** | 一键批量生成分镜和视频，单人可管理数十个视频项目 |
| **协作** | 以飞书多维表格为协作中心，支持多角色分工 |
| **质量** | AI 生成 + 人工审核，保证内容质量 |
| **一致性** | 四端数据同步（数据库/本地/飞书/前端） |

### 1.3 目标用户

| 用户类型 | 使用场景 |
|---------|---------|
| **MCN 运营** | 管理多账号矩阵，批量生产内容 |
| **内容团队** | 团队协作，分工明确（素材→脚本→视频→发布） |
| **个人博主** | 批量规划视频，后台自动处理 |

---

## 二、用户动线

### 2.1 完整工作流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            PetForge 用户动线                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐ │
│  │ 1.连接   │ -> │ 2.生成   │ -> │ 3.编辑   │ -> │ 4.生成   │ -> │5.同步 │ │
│  │   飞书   │    │   分镜   │    │   分镜   │    │   视频   │    │ 云盘  │ │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └───────┘ │
│       │              │              │              │              │        │
│       ▼              ▼              ▼              ▼              ▼        │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐ │
│  │ 加载任务 │    │ AI 生成  │    │ 预览修改 │    │ 逐段生成 │    │ 归档  │ │
│  │ 显示列表 │    │ 7段分镜  │    │ 提示词   │    │ 自动衔接 │    │ 分发  │ │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └───────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 详细步骤说明

#### 步骤 1：连接飞书表格

**用户操作**：
1. 打开批量处理工坊页面
2. 点击"连接飞书"
3. 填写飞书应用凭证（App ID、App Secret）
4. 填写多维表格信息（App Token、Table ID）
5. 点击"连接"

**系统响应**：
- 验证飞书凭证有效性
- 加载表格中的所有记录
- 为每条记录创建或关联项目
- 显示任务列表

**前置条件**：
- 飞书表格必须包含以下字段：
  - `opening_image_url`：首帧图片 URL 或附件
  - `release_date`：发布日期
  - `template_id`：模板 ID（可选，默认 eating-template）
  - `segment_count`：段数（可选，默认 7）

#### 步骤 2：批量生成分镜

**用户操作**：
1. 勾选需要生成分镜的任务（或使用筛选器）
2. 点击"批量生成分镜"按钮
3. 等待 AI 生成完成

**系统响应**：
- 调用 LLM（DeepSeek）生成分镜脚本
- 每个项目生成 7 段分镜（可配置）
- 分镜数据写入数据库
- 同步状态到飞书表格

**分镜数据结构**：
```json
{
  "segment_index": 0,
  "description": "宠物坐在食盆前，好奇地闻着食物",
  "motion_prompt": "缓慢低头，嗅探动作，耳朵微动",
  "camera_movement": "固定机位，特写",
  "duration": 5
}
```

#### 步骤 3：编辑分镜（可选）

**用户操作**：
1. 点击任务行，打开右侧详情面板
2. 预览每段分镜的首帧图和提示词
3. 点击"重新生成"按钮，打开编辑弹窗
4. 修改描述、动作提示词、时长等
5. 保存修改

**两种编辑方式**：

| 方式 | 入口 | 适用场景 |
|-----|------|---------|
| **单个编辑** | 详情面板 → 重新生成 | 精细调整单段 |
| **批量编辑** | 推进下一步 → 编辑弹窗 | 批量修改多个任务 |

#### 步骤 4：生成视频段

**用户操作**：
1. 选择要推进的任务
2. 点击"推进下一步"
3. 选择目标段（段0/段1/.../段6）
4. （可选）在弹窗中编辑提示词
5. 点击"开始生成"

**系统响应**：
- 检查前一段是否已完成（获取尾帧）
- 调用 VEO API 生成视频
- 保存视频到本地存储
- 提取首帧和尾帧
- 更新数据库和飞书状态

**段生成规则**：
- 段 0：使用首帧图片作为输入
- 段 1-6：使用前一段的尾帧作为输入
- 所有段使用同一提示词风格，确保连贯性

#### 步骤 5：合并与同步

**用户操作**：
1. 等待所有 7 段生成完成
2. 点击"批量合并"
3. 预览合并后的完整视频
4. 点击"同步到云空间"

**系统响应**：
- 使用 FFmpeg 合并视频段
- 上传到飞书云盘指定文件夹
- 更新飞书表格中的视频 URL

---

## 三、功能模块详解

### 3.1 任务管理

#### 任务列表（TaskTable）

| 功能 | 描述 |
|-----|------|
| **多选** | 支持全选、反选、按状态筛选后选择 |
| **排序** | 按发布日期、更新时间排序 |
| **筛选** | 全部 / 待处理 / 分镜已生成 / 已完成 / 失败 |
| **搜索** | 按项目 ID 搜索 |

#### 任务状态

| 状态 | 含义 | UI 显示 |
|-----|------|--------|
| `pending` | 待处理 | 灰色标签 |
| `storyboard_ready` | 分镜已生成 | 绿色标签 |
| `generating_segment_X` | 正在生成段 X | 蓝色 + 加载动画 |
| `all_segments_ready` | 所有段已完成 | 紫色标签 |
| `completed` | 已完成（含合并） | 绿色勾选 |
| `failed` | 失败 | 红色标签 |

#### 任务详情面板（TaskDetail）

| 区域 | 内容 |
|-----|------|
| **头部** | 项目 ID、任务 ID、段数、进度、更新时间 |
| **首帧图** | 开场图片预览 |
| **分镜脚本** | 7 段分镜的文字描述 |
| **分段预览** | 每段的首帧图 + 视频预览 + 操作按钮 |

### 3.2 分镜生成

#### 生成策略

| 策略 | 说明 |
|-----|------|
| **批量生成** | 选择多个任务，一键全部生成 |
| **覆盖保护** | 已有分镜的任务默认跳过，需勾选"覆盖"才会重新生成 |
| **并发控制** | 同一项目同时只能有一个分镜生成任务 |

#### LLM 提示词

分镜生成使用专门的提示词模板（`storyboard_generation.txt`），包含：
- 场景描述解析
- 7 段结构规划
- 动作提示词生成
- 镜头运动建议

### 3.3 视频生成

#### 生成流程

```
首帧图片 → 段0视频 → 段0尾帧 → 段1视频 → ... → 段6视频
```

#### 关键机制

| 机制 | 描述 |
|-----|------|
| **帧链接** | 每段的尾帧自动成为下一段的首帧 |
| **并发锁** | 同一项目同时只能生成一段 |
| **失败重试** | 失败后状态回退到 `storyboard_ready`，可重试 |
| **级联重做** | 从指定段开始，清空后续所有段，重新生成 |

### 3.4 飞书集成

#### 多维表格

| 字段 | 方向 | 说明 |
|-----|------|------|
| `opening_image_url` | 读取 | 首帧图片 |
| `release_date` | 读取 | 发布日期 |
| `project_id` | 写入 | 项目 ID |
| `status` | 写入 | 任务状态 |
| `progress` | 写入 | 进度信息 |
| `segment_N_video_url` | 写入 | 各段视频 URL |
| `storyboard_json` | 写入 | 分镜 JSON |

#### 云盘同步

| 功能 | 说明 |
|-----|------|
| **OAuth 授权** | 需要用户授权访问云盘 |
| **文件夹选择** | 指定目标文件夹 Token |
| **自动上传** | 视频生成后自动上传 |

---

## 四、数据架构

### 4.1 四端数据一致性

```
┌─────────────────────────────────────────────────────────────┐
│                      数据一致性架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────┐         ┌──────────┐         ┌──────────┐   │
│   │  飞书    │ <-----> │  数据库  │ <-----> │  前端    │   │
│   │ Bitable  │         │ (主数据) │         │  React   │   │
│   └──────────┘         └──────────┘         └──────────┘   │
│        │                    │                    │          │
│        │                    │                    │          │
│        │               ┌────┴────┐               │          │
│        └───────────────│ 本地文件 │───────────────┘          │
│                        └─────────┘                          │
│                                                             │
│   写入顺序: 数据库(主) → 本地文件(备份) → 飞书(通知)         │
│   读取顺序: 数据库(主) → 本地文件(备份)                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 数据库表结构

#### batch_tasks 表

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | INTEGER | 主键 |
| `project_id` | VARCHAR(50) | 项目 ID（唯一） |
| `feishu_table_id` | VARCHAR(100) | 飞书表格 ID |
| `feishu_record_id` | VARCHAR(100) | 飞书记录 ID |
| `template_id` | VARCHAR(50) | 模板 ID |
| `storage_path` | VARCHAR | 本地存储路径 |
| `status` | VARCHAR(50) | 任务状态 |
| `progress` | VARCHAR(50) | 进度信息 |
| `error_message` | VARCHAR | 错误信息 |
| `storyboard_json` | TEXT | 分镜 JSON |
| `segment_urls` | TEXT | 视频段 URL JSON |
| `total_segments` | INTEGER | 总段数 |
| `current_segment` | INTEGER | 当前段 |
| `publish_date` | VARCHAR(20) | 发布日期 |
| `created_at` | DATETIME | 创建时间 |
| `updated_at` | DATETIME | 更新时间 |

### 4.3 本地存储结构

```
data/uploads/projects/
├── 2026-01-27/                    # 发布日期
│   └── eating-template/           # 模板 ID
│       └── 834ea4c71a47/          # 项目 ID
│           ├── opening_image.jpg  # 首帧图片
│           ├── storyboard.json    # 分镜数据（备份）
│           ├── meta.json          # 元数据（状态等）
│           ├── frames/            # 视频帧
│           │   ├── segment_0_first.jpg
│           │   ├── segment_0_last.jpg
│           │   └── ...
│           └── segments/          # 视频段
│               ├── segment_0_segment.mp4
│               └── ...
```

---

## 五、UI 布局

### 5.1 页面结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ← 批量处理工坊                                         [刷新] [任务队列]    │
├─────────────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────┐ ┌───────────────────┐ │
│ │                                                   │ │                   │ │
│ │  ┌─────────────────────────────────────────────┐  │ │   任务详情面板    │ │
│ │  │ ○ 总数 15  ● 已完成 9  ○ 进行中 1  ○ 失败 0 │  │ │                   │ │
│ │  └─────────────────────────────────────────────┘  │ │   - 项目信息      │ │
│ │                                                   │ │   - 首帧图片      │ │
│ │  ┌─────────────────────────────────────────────┐  │ │   - 分镜脚本      │ │
│ │  │  [全部] [待处理] [分镜已生成] [已完成]      │  │ │   - 分段预览      │ │
│ │  └─────────────────────────────────────────────┘  │ │                   │ │
│ │                                                   │ │                   │ │
│ │  ┌─────────────────────────────────────────────┐  │ │                   │ │
│ │  │ □  project ID  发布日期  状态  进度  段0-6  │  │ │                   │ │
│ │  │ ☑  834ea4c71  01-27    Ready  5/7   ○○○●●  │  │ │                   │ │
│ │  │ ☑  fa31491e1  01-27    Ready  6/7   ○○○○●  │  │ │                   │ │
│ │  │ ...                                         │  │ │                   │ │
│ │  └─────────────────────────────────────────────┘  │ │                   │ │
│ │                                                   │ │                   │ │
│ └───────────────────────────────────────────────────┘ └───────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│ [批量生成分镜] [推进下一步 5] [批量合并] [同步到飞书表格] [同步到云空间]   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 组件说明

| 组件 | 位置 | 功能 |
|-----|------|------|
| `StatsBar` | 顶部 | 统计信息（总数/完成/进行中/失败） |
| `FeishuConfig` | 左上 | 飞书连接配置 |
| `TaskTable` | 左侧 | 任务列表表格 |
| `TaskDetail` | 右侧 | 任务详情面板 |
| `BatchPromptEditModal` | 弹窗 | 批量推进时的编辑弹窗 |
| `PromptEditModal` | 弹窗 | 单个分镜编辑弹窗 |
| `ApiJobQueueDrawer` | 抽屉 | API 任务队列 |

---

## 六、API 接口

### 6.1 接口列表

| 方法 | 路径 | 描述 |
|-----|------|------|
| POST | `/api/batch/connect-feishu` | 连接飞书表格 |
| GET | `/api/batch/saved-connections` | 获取保存的连接 |
| GET | `/api/batch/tasks/local` | 获取本地任务列表 |
| GET | `/api/batch/tasks` | 获取任务列表（含飞书同步） |
| POST | `/api/batch/generate-storyboards` | 批量生成分镜 |
| POST | `/api/batch/generate-segments` | 批量生成视频段 |
| POST | `/api/batch/merge-videos` | 批量合并视频 |
| POST | `/api/batch/cascade-redo` | 级联重做 |
| POST | `/api/batch/edit-and-regenerate` | 编辑并重新生成 |
| POST | `/api/batch/batch-save-prompts` | 批量保存提示词 |
| POST | `/api/batch/sync-videos` | 同步视频到飞书 |
| POST | `/api/batch/sync-to-drive` | 同步到飞书云盘 |
| GET | `/api/batch/jobs` | 获取 API 任务队列 |

### 6.2 关键接口详解

#### 连接飞书表格

```http
POST /api/batch/connect-feishu
Content-Type: application/json

{
  "table_id": "tblnj7Q3VrwLauKb",
  "app_token": "WTESbdIxUaIGcUsPji7cIzNpntd",
  "app_id": "cli_a9fb637c7fb8dbcd",
  "app_secret": "51t8wfVnOzGpaxcZl4mfIbWYYMo8jWJl"
}
```

#### 批量生成分镜

```http
POST /api/batch/generate-storyboards
Content-Type: application/json

{
  "table_id": "tblnj7Q3VrwLauKb",
  "record_ids": ["recv9omv0HgDyj", "recv9emT6bkcKQ"],
  "overwrite": false,
  "concurrency": 3
}
```

#### 批量生成视频段

```http
POST /api/batch/generate-segments
Content-Type: application/json

{
  "table_id": "tblnj7Q3VrwLauKb",
  "record_ids": ["recv9omv0HgDyj"],
  "segment_index": 0,
  "concurrency": 1
}
```

---

## 七、已修复问题

### 7.1 V2.1 版本修复列表

| 问题编号 | 描述 | 修复状态 |
|---------|------|---------|
| #8 | 段生成完成后状态显示不正确（loading） | ✅ 已修复 |
| #10 | 后台日志过多导致刷屏 | ✅ 已修复 |
| #11 | 编辑框 z-index 问题导致无法输入 | ✅ 已修复 |
| #12 | 重新生成弹窗输入框无法编辑 | ✅ 已修复 |
| #13 | 段生成失败后状态未回退 | ✅ 已修复 |

### 7.2 已实现的防护机制

| 机制 | 描述 |
|-----|------|
| **覆盖保护** | 已有分镜的任务默认不覆盖，需显式设置 `overwrite=true` |
| **并发锁** | 同一项目同时只能进行一个写操作 |
| **状态回退** | 生成失败后状态自动回退到 `storyboard_ready` |
| **四端同步** | 数据库、本地、飞书、前端保持一致 |

---

## 八、技术规格

### 8.1 技术栈

| 层次 | 技术 |
|-----|------|
| **前端** | React 18 + TypeScript + Vite + Tailwind CSS |
| **后端** | Python 3.12 + FastAPI + SQLModel |
| **数据库** | SQLite（开发）/ PostgreSQL（生产） |
| **LLM** | DeepSeek API |
| **视频生成** | Google VEO API |
| **存储** | 本地文件系统 / 阿里云 OSS |

### 8.2 性能指标

| 指标 | 值 |
|-----|-----|
| 分镜生成时间 | ~10 秒/个 |
| 视频段生成时间 | ~30-60 秒/段 |
| 并发任务数 | 3（可配置） |
| 最大段数 | 8 |

### 8.3 限制条件

| 限制 | 值 |
|-----|-----|
| 单个视频段时长 | 5-10 秒 |
| 首帧图片格式 | JPEG/PNG |
| 输出视频格式 | MP4 (H.264) |

---

*文档更新时间: 2026-01-27*
